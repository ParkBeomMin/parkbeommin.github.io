<!DOCTYPE html>
<html lang="kr">


<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>
    [WEB] web push, 이렇게 쉬운거였어? | BeomLog
  </title>
  <meta name="description" content="범민의 기술블로그입니다.">
  
  <meta name="keywords" content="
  
  ">
  
  <meta name="author" content="bmpark">

  <meta http-equiv="Cache-Control" content="no-transform"/>
  <meta http-equiv="Cache-Control" content="no-siteapp">

  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="stylesheet" href="/MyPortfolio/css/main.css">
  <link rel="stylesheet"
        href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  

  

  <script src="//cdnjs.cloudflare.com/ajax/libs/vue/1.0.25-csp/vue.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js"></script>
  <script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7426857657290789" crossorigin="anonymous" async></script>
<meta name="generator" content="Hexo 8.0.0"></head>

<body id="replica-app">

<nav class="navbar-wrapper">
  <div class="navbar">
    <div class="container clearfix">
      <a href="/MyPortfolio/" class="navbar-logo"><i class="fa fa-github"></i></a>

      <div class="navbar-search float-left desktop-only">
        <div class="navbar-search-form">
          <label for="gsc-i-id1">This website</label>
          <div id="google-search">
            <gcse:search></gcse:search>
          </div>
        </div>
      </div>

      <ul class="navbar-nav float-left">
        
        <li><a href="/MyPortfolio/archives">Archives</a></li>
        
        
        <li><a href="/MyPortfolio/categories">Categories</a></li>
        
        
        <li><a href="/MyPortfolio/tags">Tags</a></li>
        
        
        <li><a href="/MyPortfolio/atom.xml" target="_blank">RSS</a></li>
        
      </ul>

      <ul class="navbar-nav user-nav float-right desktop-only">
        <li class="user-nav-notification">
          <a><span class="user-nav-unread"></span><i class="fa fa-bell"></i></a>
        </li>
        <li>
          <a><i class="fa fa-plus"></i> <i class="fa fa-caret-down"></i></a>
        </li>
        <li class="user-nav-logo">
          <a><img src="https://avatars.githubusercontent.com/u/23355295?v=4"> <i class="fa fa-caret-down"></i></i></a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="main-container">
  <header class="header-wrapper desktop-only">
  <div class="container header-site-detail">
    <ul class="header-toolbar">
      <li class="clearfix">
        <a href="/MyPortfolio/archives" class="header-toolbar-left"><i
                  class="fa fa-file-text"></i> Posts </a>
        <a href="/MyPortfolio/archives"
           class="header-toolbar-right"> 57 </a>
      </li>
      <li>
        <a href="/MyPortfolio/tags" class="header-toolbar-left"><i
                  class="fa fa-tags"></i> Tags </a>
        <a href="/MyPortfolio/tags"
           class="header-toolbar-right"> 0 </a>
      </li>
      <li>
        <a href="/MyPortfolio/categories" class="header-toolbar-left"><i
                  class="fa fa-folder-open"></i> Categories </a>
        <a href="/MyPortfolio/categories"
           class="header-toolbar-right"> 30 </a>
      </li>
    </ul>
    <h2 class="header-title">
      <i class="fa fa-book text-muted"></i>
      <a href="/MyPortfolio/">BeomLog</a>
      
      
    </h2>
  </div>

  <div class="container">
    <div class="header-tab-wrapper clearfix">
      <span class="header-tab header-tab-selected"><i class="fa fa-thumbs-o-up"></i> Like</span>
      <span class="header-tab"><i class="fa fa-share-alt"></i> Share</span>
      <span class="header-tab"><i class="fa fa-comments-o"></i> Discussion</span>
      <span class="header-tab"><i class="fa fa-bookmark-o"></i> Bookmark </span>
      <span class="header-tab"><i class="fa fa-smile-o"></i> Smile <i class="fa fa-caret-down"></i></span>
    </div>
  </div>
</header>


<div class="post-container container">
  <h3>
    <i class="fa fa-user-o"></i>
    bmpark

    <span class="post-date float-right" title="{{moment(1690472580000).format('MMM DD, YYYY, h:mm:ss A')}}">
      <i class="fa fa-pencil-square-o"></i>
      {{moment(1690472580000).fromNow()}}
    </span>
  </h3>

  <article class="post-content">
    <h1>[WEB] web push, 이렇게 쉬운거였어?</h1>
    <img src='/images/web/banner.png'>

<blockquote>
<p>사용자들에게 푸쉬 알림을 보내고 싶은데..<br>난 앱 개발자가 아닌데..<br>언제 또 앱 개발 공부를 하지..</p>
</blockquote>
<p>앱 개발 안해도 푸쉬 알림을 보낼 수 있습니다!<br>웹 푸쉬를 활용하면 브라우저의 푸쉬 기능을 입맛대로 사용할 수 있습니다!</p>
<h2 id="🔑웹-푸쉬-구현에-앞서"><a href="#🔑웹-푸쉬-구현에-앞서" class="headerlink" title="🔑웹 푸쉬 구현에 앞서.."></a>🔑웹 푸쉬 구현에 앞서..</h2><p>웹 푸쉬 구현에 앞서 실습 환경은 아래와 같습니다.<br>다른 프레임워크라고 하더라도 기본적인 구조는 같으니 이해하시기에 어렵지 않으실 겁니다!</p>
<ul>
<li>Vue (v3.3.4)</li>
<li>Node</li>
<li>Firebase firestore</li>
</ul>
<p>( 모바일 기준 )<br>웹 푸쉬는 카카오 브라우저 및 네이버 브라우저에서는 동작하지 않습니다.<br>적절한 조치를 취해 기본 브라우저(삼성, 크롬, 사파리)로 유도해야합니다.<br>IOS의 경우, 16.4버전 이상부터 푸쉬 기능이 지원되며 PWA로 구현하여 앱을 다운로드 후 푸쉬 기능이 지원됩니다.</p>
<h2 id="📃구독-부탁드립니다"><a href="#📃구독-부탁드립니다" class="headerlink" title="📃구독 부탁드립니다."></a>📃구독 부탁드립니다.</h2><p>갑자기 구독이요..?</p>
<p>웹 푸쉬는 구독을 한 사용자에게 토큰값을 얻어서 보내야 합니다.<br>구독 버튼을 만들어 봅시다.</p>
<p>구독 버튼을 만들기 위해서는 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API">Service Worker</a>와 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/PushManager">PushManager</a>를 사용해야합니다.</p>
<p>Vue 프로젝트의 <code>/public</code> 폴더에 <code>service-worker.js</code> 파일을 만들어줍니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 웹 푸쉬 수신 시</span></span><br><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&quot;push&quot;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> text = event.<span class="property">data</span>.<span class="title function_">text</span>();</span><br><span class="line">    event.<span class="title function_">waitUntil</span>(</span><br><span class="line">        self.<span class="property">registration</span>.<span class="title function_">showNotification</span>(<span class="string">&quot;웹 푸쉬!&quot;</span>, &#123;</span><br><span class="line">            <span class="attr">body</span>: text,</span><br><span class="line">            <span class="attr">data</span>: &#123;</span><br><span class="line">                <span class="attr">url</span>: <span class="string">&quot;https://github.io/ParkBeomMin/WebPushExample&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">    );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 푸쉬 알림 클릭 시</span></span><br><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&quot;notificationclick&quot;</span>, <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">    event.<span class="property">notification</span>.<span class="title function_">close</span>();</span><br><span class="line">    event.<span class="title function_">waitUntil</span>(clients.<span class="title function_">openWindow</span>(event.<span class="property">notification</span>.<span class="property">data</span>.<span class="property">url</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>push와 notificationclick 이벤트를 등록시켜줍니다.<br>event.data.text()를 통해 푸쉬 알림에 보여줄 데이터를 가져오고 showNotification의 body값에 뿌려줍니다.<br>showNotification의 첫번째 인자는 푸쉬알림의 타이틀니니다.<br>url 부분은 notificationclick 이벤트에서 푸쉬 클릭 시 이동할 url 경로입니다.</p>
<p>이제 <code>HomeView.vue</code> 파일로 이동하여 구독 버튼과 service worker 파일을 등록하고 구독을 할 수 있는 기능을 구현해보겠습니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;requestPermission&quot;</span>&gt;</span>&#123;&#123; buttonText &#125;&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p>버튼은 위와 같이 만들고, buttonText는 구독과 구독해지를 위해 변화될 수 있도록 했습니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buttonText = <span class="title function_">ref</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">// Service Worker 등록 코드</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;serviceWorker&#x27;</span> <span class="keyword">in</span> navigator) &#123;</span><br><span class="line">        <span class="keyword">const</span> workerFile = <span class="string">&#x27;/service-worker.js&#x27;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> registration = <span class="keyword">await</span> navigator.<span class="property">serviceWorker</span>.<span class="title function_">register</span>(workerFile);</span><br><span class="line">            <span class="keyword">if</span> (registration) &#123;</span><br><span class="line">                <span class="keyword">const</span> subscription = <span class="keyword">await</span> registration.<span class="property">pushManager</span>.<span class="title function_">getSubscription</span>();</span><br><span class="line">                <span class="keyword">if</span> (subscription) &#123;</span><br><span class="line">                    buttonText.<span class="property">value</span> = <span class="string">&#x27;구독 해지하기&#x27;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    buttonText.<span class="property">value</span> = <span class="string">&#x27;구독하기&#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(e.<span class="property">message</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Service Worker in navigator error&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>이제 service worker가 등록이 되었으니, 구독 요청 기능을 구현해보겠습니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">requestPermission</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> registration = <span class="keyword">await</span> navigator.<span class="property">serviceWorker</span>.<span class="property">ready</span>;</span><br><span class="line">        <span class="keyword">const</span> subscription = <span class="keyword">await</span> registration.<span class="property">pushManager</span>.<span class="title function_">getSubscription</span>();</span><br><span class="line">        <span class="keyword">if</span> (subscription) &#123;</span><br><span class="line">            <span class="comment">// 이미 구독이 되어있다면 해지하기</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> DB에 구독 해지 정보 보내기</span></span><br><span class="line">            buttonText.<span class="property">value</span> = <span class="string">&#x27;구독하기&#x27;</span>;</span><br><span class="line">            subscription.<span class="title function_">unsubscribe</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 구독이 되어있지 않으면 구독하기</span></span><br><span class="line">            <span class="keyword">const</span> subscription = <span class="keyword">await</span> registration.<span class="property">pushManager</span>.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">                <span class="attr">userVisibleOnly</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">applicationServerKey</span>: vapidKey.<span class="property">value</span>,</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> DB에 구독 정보 보내기</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;subscription =&gt; &#x27;</span>, subscription.<span class="title function_">toJSON</span>());</span><br><span class="line">            buttonText.<span class="property">value</span> = <span class="string">&#x27;구독 해지하기&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(e.<span class="property">message</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>요청은 service worker가 등록되고 준비가 된 이후 pushManager의 getSubscription()를 통해 구독정보를 가져옵니다.<br>구독이 되어있다면 해지, 되어있지 않다면 구독을 합니다.<br>뜬금없이 <code>vapidKey.value</code> 이 친구가 나타났는데 푸쉬 발송을 위한 키값입니다. 이 키값은 서버단에서 만들어야합니다.</p>
<p>이제 Node 프로젝트로 이동합니다.</p>
<p><code>npm install -g web-push</code><br><code>web-push generate-vapid-keys</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">=======================================</span><br><span class="line"></span><br><span class="line">Public Key:</span><br><span class="line">BAHc42Ge9Ku-Hgup-66JXrkbsWuwDTUTnoh0Y5UyQFyS04UbP7NF02ZfOMMDf2ujLTMIfKlQ4cx4Thz8ek6hze8</span><br><span class="line"></span><br><span class="line">Private Key:</span><br><span class="line">TdolN_-xYH9ARuWRDULgaXO-EFgadIM39FhCSttwswc</span><br><span class="line"></span><br><span class="line">=======================================</span><br></pre></td></tr></table></figure>

<p>위 명령어를 통해 web-push를 설치하고, vapid key 값을 발급받습니다.<br>발급받은 vapid key 값 중 Public Key를 위에서 언급되었던 <code>vapidKey.value</code>에 넣어줍니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vapidKey = <span class="title function_">ref</span>(</span><br><span class="line">    <span class="string">&quot;BAHc42Ge9Ku-Hgup-66JXrkbsWuwDTUTnoh0Y5UyQFyS04UbP7NF02ZfOMMDf2ujLTMIfKlQ4cx4Thz8ek6hze8&quot;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>이제 구독 버튼을 눌러보면 아래와 같이 알림 요청과 구독 정보를 받아올 수 있습니다.</p>
<img src='/images/web/web-push-1.png'>

<img src='/images/web/web-push-2.png'>

<p>이 구독 정보를 가지고 다시 Node 프로젝트로 이동합니다.<br><code>npm install --save web-push</code></p>
<p>라이브러리 설치 후 vapid키와 구독정보를 포함해 푸쉬 발송 로직을 만들어줍니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpush = <span class="built_in">require</span>(<span class="string">&quot;web-push&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vapidKeys = &#123;</span><br><span class="line">    <span class="attr">publicKey</span>:</span><br><span class="line">        <span class="string">&quot;BAHc42Ge9Ku-Hgup-66JXrkbsWuwDTUTnoh0Y5UyQFyS04UbP7NF02ZfOMMDf2ujLTMIfKlQ4cx4Thz8ek6hze8&quot;</span>,</span><br><span class="line">    <span class="attr">privateKey</span>: <span class="string">&quot;TdolN_-xYH9ARuWRDULgaXO-EFgadIM39FhCSttwswc&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">webpush.<span class="title function_">setVapidDetails</span>(</span><br><span class="line">    <span class="string">&quot;mailto:bmpark@jinhak.com&quot;</span>,</span><br><span class="line">    vapidKeys.<span class="property">publicKey</span>,</span><br><span class="line">    vapidKeys.<span class="property">privateKey</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">webpush.<span class="title function_">sendNotification</span>(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">endpoint</span>:</span><br><span class="line">            <span class="string">&quot;https://fcm.googleapis.com/fcm/send/cRngP9o7apw:APA91bG5_i-BS2WBUSehlWxe4Pr2PLhugyvCtIcNgFSs2RcSSth60wmC61R9SH-Iq3tFpO1tqprXcFFze4ZduL-MsSGWP9DJvm7jEbWB3nM40Ui99VFNPsnoHUx-emEceevzR6vwATMn&quot;</span>,</span><br><span class="line">        <span class="attr">keys</span>: &#123;</span><br><span class="line">            <span class="attr">auth</span>: <span class="string">&quot;BjJjTUVFQi9UCBH-VqqVAg&quot;</span>,</span><br><span class="line">            <span class="attr">p256dh</span>: <span class="string">&quot;BDDJ_YGSawW1NowpbJ1Cl0N8JiFtsSuMBjjtWCly7lBrf4wnsrJP7xlVTqBKhhaMIP3RwkCfb5oSSwDVh1fbYp4&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;웹푸쉬발송!&quot;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>이제 <code>node index.js</code>로 서버를 실행시키면 웹 푸쉬 발송을 확인할 수 있습니다!</p>
<img src='/images/web/web-push-3.png'>

<h2 id="💻RESTFul한-WebPush로"><a href="#💻RESTFul한-WebPush로" class="headerlink" title="💻RESTFul한 WebPush로!"></a>💻RESTFul한 WebPush로!</h2><p>위에서 단순히 웹 푸쉬가 동작하는 것까지 했으니, 이제 db도 연결하고 서버 api로 웹 푸쉬가 발송될 수 있도록 해보겠습니다.<br>Node 프로젝트로 이동합니다.</p>
<p><code>npm install express --save</code><br><code>npm install firebase-admin --save</code></p>
<p>firebase console에서 키값 파일도 다운로드 받아놓습니다.<br>firebase project &gt; 프로젝트 설정 &gt; 서비스 계정 &gt; 새 비공개 키 생성</p>
<p>이제 기본적인 셋팅은 완료가 되었고, 구조를 잡고 구현을 합니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">├── routes</span><br><span class="line">│   ├── index.<span class="property">js</span></span><br><span class="line">│   └── webPush.<span class="property">js</span></span><br><span class="line">├── firebase-account-file.<span class="property">json</span></span><br><span class="line">├── firebase.<span class="property">js</span></span><br><span class="line">├── index.<span class="property">js</span></span><br><span class="line">├── webPush.<span class="property">controller</span>.<span class="property">js</span></span><br><span class="line">└── package.<span class="property">json</span></span><br></pre></td></tr></table></figure>

<p>기존 <code>index.js</code>의 webPush 기능들은 <code>webPush.controller.js</code>파일로 변경했습니다.<br>이제 각 파일에 대해 파헤쳐보겠습니다.</p>
<p>먼저 <code>index.js</code> 파일은 기본적인 express 라우팅 처리를 해줍니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">urlencoded</span>(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">json</span>());</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> index = <span class="built_in">require</span>(<span class="string">&quot;./routes/index&quot;</span>);</span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&quot;/&quot;</span>, index);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;WebPush Server On 3000 Port&quot;</span>));</span><br></pre></td></tr></table></figure>

<p><code>webPush.controller.js</code>에서는 vapidkey와 push를 보내는 함수를 export시켜줍니다.<br>vapidKey는 서버에서 발급받은 키를 고정으로 프론트와 같게 사용해야하기 때문에 Vapid값을 보내주는 함수를 만들었습니다.<br>dev, production 환경에서 각각 달라지므로 cross-env를 활용해 config값으로 셋팅하여 사용해도 좋습니다!</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpush = <span class="built_in">require</span>(<span class="string">&quot;web-push&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vapidKeys = &#123;</span><br><span class="line">    <span class="attr">publicKey</span>:</span><br><span class="line">        <span class="string">&quot;BAHc42Ge9Ku-Hgup-66JXrkbsWuwDTUTnoh0Y5UyQFyS04UbP7NF02ZfOMMDf2ujLTMIfKlQ4cx4Thz8ek6hze8&quot;</span>,</span><br><span class="line">    <span class="attr">privateKey</span>: <span class="string">&quot;TdolN_-xYH9ARuWRDULgaXO-EFgadIM39FhCSttwswc&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">webpush.<span class="title function_">setVapidDetails</span>(</span><br><span class="line">    <span class="string">&quot;mailto:club20608@gmail.com&quot;</span>,</span><br><span class="line">    vapidKeys.<span class="property">publicKey</span>,</span><br><span class="line">    vapidKeys.<span class="property">privateKey</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getVapidKey</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> vapidKeys.<span class="property">publicKey</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">push</span> = (<span class="params">&#123; data, tokens &#125;</span>) =&gt; &#123;</span><br><span class="line">    tokens.<span class="title function_">forEach</span>(<span class="title function_">async</span> (token) =&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> webpush.<span class="title function_">sendNotification</span>(token, data.<span class="property">message</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123; getVapidKey, push &#125;;</span><br></pre></td></tr></table></figure>

<p><code>firebase.js</code>에서는 firebase를 초기화하고 firestore db와 통신하는 기능들을 구현합니다.<br>토큰을 db에 추가&#x2F;삭제하고 가져와서 발송처리를 합니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">    initializeApp,</span><br><span class="line">    applicationDefault,</span><br><span class="line">    cert,</span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&quot;firebase-admin/app&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; getFirestore &#125; = <span class="built_in">require</span>(<span class="string">&quot;firebase-admin/firestore&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; push &#125; = <span class="built_in">require</span>(<span class="string">&quot;./webPush.controller&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> serviceAccount = <span class="built_in">require</span>(<span class="string">&quot;./firebase-account-file.json&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">initializeApp</span>(&#123;</span><br><span class="line">    <span class="attr">credential</span>: <span class="title function_">cert</span>(serviceAccount),</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> db = <span class="title function_">getFirestore</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">setToken</span> = <span class="keyword">async</span> (<span class="params">&#123; endpoint, keys &#125;</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> isExist = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">const</span> q = db.<span class="title function_">collection</span>(<span class="string">&quot;token&quot;</span>).<span class="title function_">where</span>(<span class="string">&quot;endpoint&quot;</span>, <span class="string">&quot;==&quot;</span>, endpoint);</span><br><span class="line">    <span class="keyword">const</span> querySnapshot = <span class="keyword">await</span> q.<span class="title function_">get</span>();</span><br><span class="line">    querySnapshot.<span class="title function_">forEach</span>(<span class="function">(<span class="params">doc</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (doc.<span class="property">id</span>) &#123;</span><br><span class="line">            isExist = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!isExist) &#123;</span><br><span class="line">        <span class="keyword">const</span> today = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        db.<span class="title function_">collection</span>(<span class="string">&quot;token&quot;</span>).<span class="title function_">add</span>(&#123;</span><br><span class="line">            endpoint,</span><br><span class="line">            keys,</span><br><span class="line">            <span class="attr">regDate</span>: today,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">deleteToken</span> = <span class="keyword">async</span> (<span class="params">&#123; endpoint, keys &#125;</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> q = db.<span class="title function_">collection</span>(<span class="string">&quot;token&quot;</span>).<span class="title function_">where</span>(<span class="string">&quot;endpoint&quot;</span>, <span class="string">&quot;==&quot;</span>, endpoint); <span class="comment">// query(collection(db, &#x27;token&#x27;), where(&#x27;endpoint&#x27;, &#x27;==&#x27;, true));</span></span><br><span class="line">    <span class="keyword">const</span> querySnapshot = <span class="keyword">await</span> q.<span class="title function_">get</span>();</span><br><span class="line">    querySnapshot.<span class="title function_">forEach</span>(<span class="function">(<span class="params">doc</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (doc.<span class="property">id</span>) &#123;</span><br><span class="line">            db.<span class="title function_">doc</span>(<span class="string">`token/<span class="subst">$&#123;doc.id&#125;</span>`</span>).<span class="title function_">delete</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">sendMessage</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> registrationTokens = [];</span><br><span class="line">    <span class="keyword">const</span> docs = <span class="keyword">await</span> db.<span class="title function_">collection</span>(<span class="string">&quot;token&quot;</span>).<span class="title function_">get</span>();</span><br><span class="line">    <span class="comment">// 디비에 등록된 토큰 가져오기</span></span><br><span class="line">    docs.<span class="title function_">forEach</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">        registrationTokens.<span class="title function_">push</span>(&#123; ...result.<span class="title function_">data</span>() &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> message = &#123;</span><br><span class="line">        <span class="attr">data</span>: &#123;</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&quot;웹푸쉬!&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">tokens</span>: registrationTokens.<span class="title function_">filter</span>(<span class="function">(<span class="params">r</span>) =&gt;</span> r.<span class="property">endpoint</span>),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="title function_">push</span>(message);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    setToken,</span><br><span class="line">    sendMessage,</span><br><span class="line">    deleteToken,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>routes/index.js</code>에서는 webPush 경로로 라우팅 해줍니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = express.<span class="title class_">Router</span>();</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">use</span>(express.<span class="title function_">urlencoded</span>(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">router.<span class="title function_">use</span>(express.<span class="title function_">json</span>());</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> webPush = <span class="built_in">require</span>(<span class="string">&quot;./webPush.js&quot;</span>);</span><br><span class="line">router.<span class="title function_">use</span>(<span class="string">&quot;/webPush&quot;</span>, webPush);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router;</span><br></pre></td></tr></table></figure>

<p>마지막으로 <code>routes/webPush.js</code>에서 각 api들을 구현해줍니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; setToken, deleteToken, sendMessage &#125; = <span class="built_in">require</span>(<span class="string">&quot;../firebase&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; getVapidKey &#125; = <span class="built_in">require</span>(<span class="string">&quot;../webPush.controller&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.<span class="title class_">Router</span>();</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">use</span>(express.<span class="title function_">urlencoded</span>(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">router.<span class="title function_">use</span>(express.<span class="title function_">json</span>());</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/&quot;</span>, <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    res.<span class="title function_">json</span>(&#123; <span class="attr">rtCode</span>: <span class="string">&quot;S&quot;</span>, <span class="attr">vapidKey</span>: <span class="title function_">getVapidKey</span>() &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; endpoint, keys &#125; = req.<span class="property">body</span>;</span><br><span class="line">    <span class="title function_">setToken</span>(&#123; endpoint, keys &#125;);</span><br><span class="line">    res.<span class="title function_">json</span>(&#123; <span class="attr">rtCode</span>: <span class="string">&quot;S&quot;</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/delToken&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; endpoint &#125; = req.<span class="property">body</span>;</span><br><span class="line">    <span class="title function_">deleteToken</span>(&#123; <span class="attr">endpoint</span>: <span class="built_in">decodeURIComponent</span>(endpoint) &#125;);</span><br><span class="line">    res.<span class="title function_">json</span>(&#123; <span class="attr">rtCode</span>: <span class="string">&quot;S&quot;</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/send&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">sendMessage</span>();</span><br><span class="line">    res.<span class="title function_">json</span>(&#123; <span class="attr">rtoCode</span>: <span class="string">&quot;S&quot;</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router;</span><br></pre></td></tr></table></figure>

<p>이제 Vue 프로젝트로 이동하여 api 호출을 구현합니다.</p>
<p><code>npm i --save axios</code></p>
<p><code>main.ts</code>로 이동하여 axios를 글로벌하게 사용할 수 있게 등록해줍니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="property">config</span>.<span class="property">globalProperties</span>.<span class="property">$axios</span> = axios;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(router);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>이제 <code>vite.config.ts</code>로 이동하여 api 서버가 제대로 호출될 수 있도록 server 설정을 해줍니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="attr">server</span>: &#123;</span><br><span class="line">        <span class="attr">port</span>: <span class="number">3001</span>,</span><br><span class="line">        <span class="attr">cors</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">proxy</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;/api&#x27;</span>: &#123;</span><br><span class="line">                <span class="attr">target</span>: <span class="string">&#x27;http://localhost:3000&#x27;</span>,</span><br><span class="line">                <span class="attr">changeOrigin</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">rewrite</span>: <span class="function">(<span class="params">path</span>) =&gt;</span> path.<span class="title function_">replace</span>(<span class="regexp">/^\/api/</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>페이지 랜딩 시 vapidKey 값을 받아와서 셋팅될 수 있도록 합니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; onMounted, getCurrentInstance, ref, nextTick &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> instance = <span class="title function_">getCurrentInstance</span>();</span><br><span class="line"><span class="keyword">const</span> vapidKey = <span class="title function_">ref</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> ds = <span class="title function_">await</span> (instance?.<span class="property">proxy</span> <span class="keyword">as</span> any).<span class="property">$axios</span>.<span class="title function_">get</span>(<span class="string">&#x27;/api/webPush&#x27;</span>);</span><br><span class="line">  vapidKey.<span class="property">value</span> = ds.<span class="property">data</span>.<span class="property">vapidKey</span>;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><code>requestPermission</code> 함수에서 TODO로 남겨놓았던 부분에도 토큰값이 셋팅될 수 있도록 추가해줍니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">requestPermission</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> registration = <span class="keyword">await</span> navigator.<span class="property">serviceWorker</span>.<span class="property">ready</span>;</span><br><span class="line">        <span class="keyword">const</span> subscription = <span class="keyword">await</span> registration.<span class="property">pushManager</span>.<span class="title function_">getSubscription</span>();</span><br><span class="line">        <span class="keyword">if</span> (subscription) &#123;</span><br><span class="line">            <span class="comment">// 이미 구독이 되어있다면 해지하기</span></span><br><span class="line">            <span class="title function_">await</span> (instance?.<span class="property">proxy</span> <span class="keyword">as</span> any).<span class="property">$axios</span>.<span class="title function_">post</span>(<span class="string">`/api/webPush/delToken`</span>, subscription);</span><br><span class="line">            buttonText.<span class="property">value</span> = <span class="string">&#x27;구독하기&#x27;</span>;</span><br><span class="line">            subscription.<span class="title function_">unsubscribe</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 구독이 되어있지 않으면 구독하기</span></span><br><span class="line">            <span class="keyword">const</span> subscription = <span class="keyword">await</span> registration.<span class="property">pushManager</span>.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">                <span class="attr">userVisibleOnly</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">applicationServerKey</span>: vapidKey.<span class="property">value</span>,</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;subscription =&gt; &#x27;</span>, subscription.<span class="title function_">toJSON</span>());</span><br><span class="line">            <span class="title function_">await</span> (instance?.<span class="property">proxy</span> <span class="keyword">as</span> any).<span class="property">$axios</span>.<span class="title function_">post</span>(<span class="string">&#x27;/api/webPush&#x27;</span>, subscription);</span><br><span class="line">            buttonText.<span class="property">value</span> = <span class="string">&#x27;구독 해지하기&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(e.<span class="property">message</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>이제 구독 버튼 클릭 시 DB에 토큰이 저장되고 모든 셋팅이 끝났습니다.<br>postman 프로그램으로 <code>/webPush/send</code> api를 호출하면 웹 푸쉬가 정상적으로 오는 것을 확인할 수 있습니다!</p>
<img src='/images/web/web-push-4.png'>

<h2 id="😮-IOS는요"><a href="#😮-IOS는요" class="headerlink" title="😮 IOS는요??"></a>😮 IOS는요??</h2><p>IOS는 처음에 말씀드린 것과 같이 사파리 16.4 버전 이상에서 동작이 가능하며 PWA로 만들어야합니다.<br>PWA로 만드는 것은 기존 웹사이트에 Manifest만 등록해주면 됩니다!</p>
<p>Vue 프로젝트로 이동하여 <code>public/manifest.json</code> 파일을 만들어줍니다.<br>icon 파일들은 <a target="_blank" rel="noopener" href="https://www.favicon-generator.org/">favicon-generator</a>사이트에서 만들어주면 편리합니다.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;short_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;웹푸쉬&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;웹푸쉬&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;start_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;webpush&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;display&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standalone&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;theme_color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#ffc107&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;backgroun_color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#ffc107&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;icons&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;src&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/android-icon-36x36.png&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sizes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;36x36&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;image/png&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;density&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.75&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;src&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/android-icon-48x48.png&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sizes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;48x48&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;image/png&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;density&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;src&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/android-icon-72x72.png&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sizes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;72x72&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;image/png&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;density&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.5&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;src&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/android-icon-96x96.png&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sizes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;96x96&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;image/png&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;density&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;src&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/android-icon-144x144.png&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sizes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;144x144&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;image/png&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;density&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3.0&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;src&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/android-icon-192x192.png&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sizes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192x192&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;image/png&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;density&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4.0&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>그리고 <code>index.html</code>로 가서 head태그 안에 mainfest파일을 등록해줍니다.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;manifest&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/manifest.json&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;icon&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/favicon.ico&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>Vite App<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/src/main.ts&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>이제 실행을 시켜보면 아래와 같이 앱을 다운로드 받을 수 있습니다.<br>IOS 환경에서는 ‘홈화면에 추가’를 통해 앱이 설치가 되고, 구독버튼을 눌러 웹 푸쉬 기능을 사용할 수 있습니다.</p>
<img src='/images/web/web-push-5.png'>

<hr>
<p>모든 소스코드는 <a target="_blank" rel="noopener" href="https://github.com/ParkBeomMin/WebPushExample">WebPushExample</a>와 <a target="_blank" rel="noopener" href="https://github.com/ParkBeomMin/WebPushServerExample">WebPushServerExample</a>에서 확인하실 수 있습니다.</p>

  </article>
</div>


    




</div>

<div class="footer-wrapper container">
  <footer class="footer clearfix">
    <a href="https://parkbeommin.github.io/MyPortfolio" class="footer-logo">
      <i class="fa fa-github"></i>
    </a>
    <ul class="footer-social-link">
      <li>© 2025 bmpark</li>
      <li><a href="https://parkbeommin.github.io/MyPortfolio">Home</a></li>
      
      <li><a target="_blank" rel="noopener" href="https://github.com/parkbeommin">Github</a></li>
      
    </ul>
    <div class="footer-theme-info">
      Theme <a target="_blank" rel="noopener" href="//github.com/sabrinaluo/hexo-theme-replica">Replica</a>
      by <a target="_blank" rel="noopener" href="//github.com/sabrinaluo">Hiitea</a> ❤ Powered by Hexo
    </div>
  </footer>
</div>




<script src="/MyPortfolio/js/main.js"></script>

</body>
</html>
